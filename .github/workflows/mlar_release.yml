name: mlar release
# This workflow builds and releases the MLAR binary across major platforms,
# including legacy Windows 7 targets using tier-3 targets and custom std builds.

permissions: {}

on:
  push:
    tags:
      - "mlar-v*"

env:
  GITHUB_REF: "${{ github.ref }}"

jobs:
  build:
    strategy:
      matrix:
        build: [linux, macos, windows]
        include:
          - build: linux
            os: ubuntu-latest
            # use a pinned Rust toolchain via a Linux container for reproducible builds
            container: rust@sha256:f58923369ba295ae1f60bc49d03f2c955a5c93a0b7d49acfb2b2a65bebaf350d # v1.92.0 ("old-stable" cf. below)
            target: x86_64-unknown-linux-musl
            cargo_build: --target x86_64-unknown-linux-musl
          - build: macos
            os: macos-latest
            # not available: set container value to null
            container: null
          - build: windows
            os: windows-latest
            # not available: set container value to null
            container: null
            extension: .exe
          - build: windows7-i686 # Win7-compatible build using tier 3 target
            os: windows-latest
            # not available: set container value to null
            container: null
            target: i686-win7-windows-msvc
            cargo_build: --target i686-win7-windows-msvc -Z build-std # Build std from source, needed for tier 3 target
            extension: .exe
          - build: windows7-x86_64 # Win7-compatible build using tier 3 target
            os: windows-latest
            # not available: set container value to null
            container: null
            target: x86_64-win7-windows-msvc
            cargo_build: --target x86_64-win7-windows-msvc -Z build-std # Build std from source, needed for tier 3 target
            extension: .exe

    runs-on: ${{matrix.os}}
    container: ${{matrix.container}}

    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - name: Set target if any
      # Skip rustup target add for win7 targets â€” rustup doesn't support these tier-3 targets
      if: matrix.target && !contains(matrix.target, 'win7')
      run: rustup target add ${{ matrix.target }}
    - name: Install rust-src (only for win7)
      # For win7 targets, manually build std by installing rust-src
      if: contains(matrix.target, 'win7')
      run: rustup component add rust-src
    - name: Cache build-std artifacts (only for win7)
      # Only apply caching to Win7 tier-3 targets that require build-std
      if: contains(matrix.target, 'win7')
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
      with:
        # Cache the parts of target/ that contain compiled std artifacts for the given target
        path: |
          target/${{ matrix.target }}/release/build
          target/${{ matrix.target }}/release/deps
          target/${{ matrix.target }}/release/.fingerprint
        # Unique cache key: includes OS, target, and hash of Cargo.lock
        key: build-std-${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
        # If there's no exact match, fall back to older caches for the same target
        restore-keys: |
          build-std-${{ runner.os }}-${{ matrix.target }}-
    - name: Build (inside container)
      if: matrix.container != null
      run: cargo build --release --all-features --package mlar --verbose ${{ matrix.cargo_build }}
    - name: Build (outside container)
      if: matrix.container == null
      env:
        # RUSTC_BOOTSTRAP=1 allows use of -Z build-std on stable toolchain
        # Required because win7 targets aren't officially supported in stable
        RUSTC_BOOTSTRAP: "${{ contains(matrix.target, 'win7') && '1' || '' }}"
      run: cargo build --release --all-features --package mlar --verbose ${{ matrix.cargo_build }}
    - name: Upload resulting 'mlar'
      uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
      with:
        name: mlar-${{ matrix.build }}
        path: ./target/${{ matrix.target }}/release/mlar${{ matrix.extension }}

  release:
    permissions:
      # Used to generate artifact attestation
      attestations: write
      # Used to upload release artifacts
      contents: write
      # Use to sign the release artifacts
      id-token: write
    # From https://github.com/cloudflare/wrangler/blob/master/.github/workflows/release.yml
    name: GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Query version number
        id: get_version
        shell: bash
        run: |
          echo "using version tag ${GITHUB_REF:15}"
          echo "version=${GITHUB_REF:15}" >> $GITHUB_OUTPUT
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Get Changelog Entry
        id: changelog_reader
        uses: mindsers/changelog-reader-action@32aa5b4c155d76c94e4ec883a223c947b2f02656 # v2.2.3
        with:
          path: ./mlar/CHANGELOG.md
      - name: Create Release
        id: create_release
        uses: actions/create-release@0cb9c9b65d5d1901c1f53e5e66eaf4afd303e70e # v1.1.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: mlar-${{ steps.get_version.outputs.VERSION }}
          release_name: mlar-${{ steps.get_version.outputs.VERSION }}
          body: ${{ steps.changelog_reader.outputs.changes }}
          draft: true

      - name: Download Linux artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: mlar-linux
          path: mlar-linux

      - name: Download Windows artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: mlar-windows
          path: mlar-windows

      - name: Download Windows 32-bit Win7 artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: mlar-windows7-i686
          path: mlar-windows7-i686

      - name: Download Windows 64-bit Win7 artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: mlar-windows7-x86_64
          path: mlar-windows7-x86_64

      - name: Download MacOS artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: mlar-macos
          path: mlar-macos

      - name: Release Linux artifact
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./mlar-linux/mlar
          asset_content_type: application/octet-stream
          asset_name: mlar-linux-static-${{ steps.get_version.outputs.VERSION }}

      - name: Release Windows artifact
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./mlar-windows/mlar.exe
          asset_content_type: application/octet-stream
          asset_name: mlar-windows-${{ steps.get_version.outputs.VERSION }}.exe

      - name: Release Windows 32-bit Win7 artifact
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./mlar-windows7-i686/mlar.exe
          asset_content_type: application/octet-stream
          asset_name: mlar-windows7-i686-${{ steps.get_version.outputs.VERSION }}.exe

      - name: Release Windows 64-bit Win7 artifact
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./mlar-windows7-x86_64/mlar.exe
          asset_content_type: application/octet-stream
          asset_name: mlar-windows7-x86_64-${{ steps.get_version.outputs.VERSION }}.exe

      - name: Release MacOS artifact
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./mlar-macos/mlar
          asset_content_type: application/octet-stream
          asset_name: mlar-macos-${{ steps.get_version.outputs.VERSION }}

      - name: Attest artifacts
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: |
            ./mlar-linux/mlar
            ./mlar-windows/mlar.exe
            ./mlar-windows7-i686/mlar.exe
            ./mlar-windows7-x86_64/mlar.exe
            ./mlar-macos/mlar

  publish:
    name: Publish mlar
    needs: release
    runs-on: ubuntu-latest
    container: rust@sha256:f58923369ba295ae1f60bc49d03f2c955a5c93a0b7d49acfb2b2a65bebaf350d # v1.92.0 : Pin to known-good previous stable release for increased stability and security
    environment:
      name: cratesio
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec
        id: auth
      - name: Publish to crates.io
        run: cargo publish --package mlar
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
